# Firebase Mobile Setup - Real-time & Offline Support

## ðŸŽ¯ Perfect for Your Requirements!

Firebase is **ideal** for your needs:
- âœ… **Mobile-first** - Built for mobile apps
- âœ… **Real-time updates** - Firestore syncs instantly
- âœ… **Offline support** - Works without internet
- âœ… **Push notifications** - FCM for alerts

---

## ðŸ“± Step 1: Add Firebase to Flutter

### Update `pubspec.yaml`:

```yaml
dependencies:
  flutter:
    sdk: flutter
  provider: ^6.1.1
  http: ^1.1.0
  record: ^5.0.4
  sensors_plus: ^4.0.2
  permission_handler: ^11.1.0
  path_provider: ^2.1.1
  shared_preferences: ^2.2.2
  
  # Firebase packages
  firebase_core: ^2.24.0
  firebase_messaging: ^14.7.0
  firebase_storage: ^11.5.0
  cloud_firestore: ^4.13.0
```

Then run:
```bash
cd frontend
flutter pub get
```

---

## ðŸ”§ Step 2: Configure Firebase for Flutter

### Option A: Using FlutterFire CLI (Recommended)

1. **Install FlutterFire CLI:**
   ```bash
   dart pub global activate flutterfire_cli
   ```

2. **Configure Firebase:**
   ```bash
   cd frontend
   flutterfire configure
   ```
   - Select your Firebase project
   - Select platforms: Android, iOS
   - This creates `firebase_options.dart` automatically

### Option B: Manual Setup

1. **Download `google-services.json`** (Android):
   - Firebase Console â†’ Project Settings
   - Download `google-services.json`
   - Place in: `frontend/android/app/`

2. **Download `GoogleService-Info.plist`** (iOS):
   - Download `GoogleService-Info.plist`
   - Place in: `frontend/ios/Runner/`

---

## ðŸš€ Step 3: Initialize Firebase in Flutter

### Update `lib/main.dart`:

```dart
import 'package:flutter/material.dart';
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart'; // Generated by flutterfire configure
import 'package:provider/provider.dart';
// ... other imports

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Initialize Firebase
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  
  runApp(const MyApp());
}
```

---

## ðŸ“¡ Step 4: Create Firebase Services

### A. Real-time Service (`lib/services/firebase_realtime_service.dart`):

```dart
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_messaging/firebase_messaging.dart';

class FirebaseRealtimeService {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseMessaging _messaging = FirebaseMessaging.instance;
  
  // Get FCM token for push notifications
  Future<String?> getFCMToken() async {
    try {
      String? token = await _messaging.getToken();
      return token;
    } catch (e) {
      print('Error getting FCM token: $e');
      return null;
    }
  }
  
  // Save FCM token to backend
  Future<void> saveFCMToken(int userId, String token) async {
    try {
      // Save to your backend API
      // await apiService.updateFCMToken(userId, token);
      
      // Also save to Firestore for real-time sync
      await _firestore.collection('users').doc(userId.toString()).set({
        'fcm_token': token,
        'last_updated': FieldValue.serverTimestamp(),
      }, SetOptions(merge: true));
    } catch (e) {
      print('Error saving FCM token: $e');
    }
  }
  
  // Listen to real-time user data updates
  Stream<Map<String, dynamic>?> listenToUserData(int userId) {
    return _firestore
        .collection('users')
        .doc(userId.toString())
        .snapshots()
        .map((snapshot) {
      if (snapshot.exists) {
        return snapshot.data() as Map<String, dynamic>;
      }
      return null;
    });
  }
  
  // Listen to real-time alerts
  Stream<List<Map<String, dynamic>>> listenToAlerts(int userId) {
    return _firestore
        .collection('alerts')
        .where('user_id', isEqualTo: userId)
        .where('is_resolved', isEqualTo: false)
        .orderBy('created_at', descending: true)
        .snapshots()
        .map((snapshot) {
      return snapshot.docs.map((doc) => {
        return {
          'id': doc.id,
          ...doc.data() as Map<String, dynamic>,
        };
      }).toList();
    });
  }
  
  // Update user's depression score in real-time
  Future<void> updateDepressionScore(int userId, double score, String riskLevel) async {
    await _firestore.collection('users').doc(userId.toString()).set({
      'depression_score': score,
      'risk_level': riskLevel,
      'last_updated': FieldValue.serverTimestamp(),
    }, SetOptions(merge: true));
  }
  
  // Enable offline persistence (works offline!)
  Future<void> enableOfflinePersistence() async {
    await _firestore.settings = const Settings(
      persistenceEnabled: true,
      cacheSizeBytes: Settings.CACHE_SIZE_UNLIMITED,
    );
  }
}
```

### B. Notification Service (`lib/services/notification_service.dart`):

```dart
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';

class NotificationService {
  final FirebaseMessaging _messaging = FirebaseMessaging.instance;
  final FlutterLocalNotificationsPlugin _localNotifications = 
      FlutterLocalNotificationsPlugin();
  
  Future<void> initialize() async {
    // Request permission
    NotificationSettings settings = await _messaging.requestPermission(
      alert: true,
      badge: true,
      sound: true,
    );
    
    if (settings.authorizationStatus == AuthorizationStatus.authorized) {
      print('User granted notification permission');
    }
    
    // Initialize local notifications
    const AndroidInitializationSettings androidSettings =
        AndroidInitializationSettings('@mipmap/ic_launcher');
    
    const InitializationSettings initSettings = InitializationSettings(
      android: androidSettings,
    );
    
    await _localNotifications.initialize(initSettings);
    
    // Handle foreground messages
    FirebaseMessaging.onMessage.listen(_handleForegroundMessage);
    
    // Handle background messages (when app is closed)
    FirebaseMessaging.onBackgroundMessage(_firebaseMessagingBackgroundHandler);
    
    // Handle notification taps
    FirebaseMessaging.onMessageOpenedApp.listen(_handleNotificationTap);
  }
  
  void _handleForegroundMessage(RemoteMessage message) {
    // Show local notification when app is in foreground
    _localNotifications.show(
      message.hashCode,
      message.notification?.title,
      message.notification?.body,
      const NotificationDetails(
        android: AndroidNotificationDetails(
          'high_importance_channel',
          'High Importance Notifications',
          importance: Importance.high,
        ),
      ),
    );
  }
  
  void _handleNotificationTap(RemoteMessage message) {
    // Navigate to relevant screen when notification is tapped
    print('Notification tapped: ${message.data}');
  }
}

// Background message handler (must be top-level function)
@pragma('vm:entry-point')
Future<void> _firebaseMessagingBackgroundHandler(RemoteMessage message) async {
  print('Handling background message: ${message.messageId}');
}
```

---

## ðŸ”„ Step 5: Update Providers for Real-time

### Update `lib/providers/auth_provider.dart`:

```dart
import 'package:cloud_firestore/cloud_firestore.dart';
import '../services/firebase_realtime_service.dart';
import '../services/notification_service.dart';

class AuthProvider with ChangeNotifier {
  final ApiService _apiService = ApiService();
  final FirebaseRealtimeService _firebaseService = FirebaseRealtimeService();
  final NotificationService _notificationService = NotificationService();
  
  User? _user;
  String? _token;
  StreamSubscription<Map<String, dynamic>?>? _userDataSubscription;
  
  // ... existing code ...
  
  Future<bool> login(String username, String password) async {
    try {
      final response = await _apiService.login(username, password);
      _token = response['access_token'];
      _apiService.setToken(_token!);
      
      final userInfo = await _apiService.getCurrentUser();
      _user = User.fromJson(userInfo);
      
      // Initialize Firebase services
      await _initializeFirebaseServices();
      
      notifyListeners();
      return true;
    } catch (e) {
      return false;
    }
  }
  
  Future<void> _initializeFirebaseServices() async {
    if (_user == null) return;
    
    // Initialize notifications
    await _notificationService.initialize();
    
    // Get and save FCM token
    String? fcmToken = await _firebaseService.getFCMToken();
    if (fcmToken != null) {
      await _firebaseService.saveFCMToken(_user!.id, fcmToken);
    }
    
    // Listen to real-time user data updates
    _userDataSubscription = _firebaseService
        .listenToUserData(_user!.id)
        .listen((data) {
      if (data != null) {
        // Update UI when data changes in real-time
        print('Real-time update received: $data');
        notifyListeners();
      }
    });
  }
  
  @override
  void dispose() {
    _userDataSubscription?.cancel();
    super.dispose();
  }
}
```

---

## ðŸ“¦ Step 6: Add Local Notifications Package

Add to `pubspec.yaml`:
```yaml
dependencies:
  flutter_local_notifications: ^16.3.0
```

---

## ðŸŽ¯ Step 7: Use Real-time Updates in Your App

### Example: Real-time Dashboard

```dart
class DashboardScreen extends StatelessWidget {
  final int userId;
  
  @override
  Widget build(BuildContext context) {
    return StreamBuilder<Map<String, dynamic>?>(
      stream: FirebaseRealtimeService().listenToUserData(userId),
      builder: (context, snapshot) {
        if (snapshot.hasData && snapshot.data != null) {
          final data = snapshot.data!;
          return Column(
            children: [
              Text('Depression Score: ${data['depression_score']}'),
              Text('Risk Level: ${data['risk_level']}'),
              // Updates automatically when data changes!
            ],
          );
        }
        return CircularProgressIndicator();
      },
    );
  }
}
```

---

## ðŸ”” Step 8: Send Notifications from Backend

When you detect high risk, send notification:

```python
# In your backend code
from app.services.firebase_service import send_notification_with_realtime_update

# When depression score is high
if depression_score > 0.7:
    send_notification_with_realtime_update(
        user_id=user.id,
        fcm_token=user.fcm_token,
        title="High Risk Alert",
        body="Your depression score indicates high risk. Please contact support.",
        alert_data={
            'type': 'high_risk',
            'severity': 'high',
            'score': str(depression_score)
        }
    )
```

---

## ðŸ’¾ Offline Support

Firestore **automatically** handles offline:
- âœ… Caches data locally
- âœ… Works without internet
- âœ… Syncs when connection restored
- âœ… No extra code needed!

Just enable persistence (already in the service above).

---

## ðŸ§ª Test Real-time Updates

1. **Update data in Firebase Console:**
   - Go to Firestore Database
   - Update a user document
   - Watch your app update instantly!

2. **Send test notification:**
   - Firebase Console â†’ Cloud Messaging
   - Send test message
   - App receives it immediately!

---

## ðŸ“š Next Steps

1. âœ… Add Firebase packages to `pubspec.yaml`
2. âœ… Run `flutterfire configure`
3. âœ… Initialize Firebase in `main.dart`
4. âœ… Create Firebase services
5. âœ… Update providers for real-time
6. âœ… Test offline functionality
7. âœ… Send notifications from backend

---

## ðŸŽ‰ Benefits You Get

- âœ… **Real-time sync** - Changes appear instantly
- âœ… **Offline support** - App works without internet
- âœ… **Push notifications** - Instant alerts
- âœ… **Automatic sync** - No manual refresh needed
- âœ… **Mobile-optimized** - Built for mobile apps

**Perfect for your requirements!** ðŸš€


